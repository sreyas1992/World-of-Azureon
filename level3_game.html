<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3: Ember Castle - Platformer Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* ===============================================
           GLOBAL STYLES & RESET
        =============================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #1a0f0a, #2F1B14, #3a1f1a);
            color: #e8e3d3;
            overflow: hidden;
            height: 100vh;
        }

        /* ===============================================
           GAME CANVAS & CONTAINER
        =============================================== */
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(to bottom, #2F1B14, #1a0f0a);
            cursor: crosshair;
            z-index: 1;
        }

        /* ===============================================
           GAME HUD - Level 1 Style
        =============================================== */
        .game-hud {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 20px;
            pointer-events: none;
        }

        .hud-panel {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(26, 26, 46, 0.7));
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 10px 15px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .hud-label {
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            color: #d4af37;
            margin-bottom: 5px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .hud-value {
            font-size: 1.4em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        /* ===============================================
           PAGE PROGRESS INDICATOR
        =============================================== */
        .page-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(26, 26, 46, 0.7));
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 10px 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .page-indicator .hud-label {
            font-family: 'Cinzel', serif;
            font-size: 0.9em;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .page-indicator .hud-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
        }

        /* ===============================================
           VICTORY SCREEN
        =============================================== */
        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.9), rgba(255, 69, 0, 0.8));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease-in-out;
        }

        .victory-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .victory-content {
            text-align: center;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(26, 26, 46, 0.8));
            border: 3px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.8);
        }

        .victory-title {
            font-family: 'Cinzel', serif;
            font-size: 3em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: victoryGlow 2s ease-in-out infinite alternate;
        }

        @keyframes victoryGlow {
            0% { text-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
            100% { text-shadow: 0 0 50px rgba(255, 215, 0, 1), 0 0 70px rgba(255, 69, 0, 0.8); }
        }

        .victory-message {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #e8e3d3;
        }

        .btn-epic {
            background: linear-gradient(135deg, #8B0000, #FF4500, #FFD700);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px 30px;
            font-family: 'Cinzel', serif;
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        .btn-epic:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.6);
            background: linear-gradient(135deg, #FF4500, #FFD700, #FFA500);
        }

        /* ===============================================
           DEBUG PANEL
        =============================================== */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #d4af37;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.8em;
            color: #d4af37;
            display: none;
        }

        .debug-panel.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Game HUD - Level 1 Style -->
    <div class="game-hud">
        <div class="hud-panel">
            <div class="hud-label">Hero Score</div>
            <div class="hud-value" id="heroScore">0</div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">Kingdom Score</div>
            <div class="hud-value" id="kingdomScore">0</div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">Lives</div>
            <div class="hud-value" id="livesCount">3 <span id="forestRelicStar" style="display: none;">‚≠ê</span></div>
        </div>
        <div class="hud-panel">
            <div class="hud-label">Ember Relic</div>
            <div class="hud-value" id="emberRelic">‚ùå</div>
        </div>
    </div>

    <!-- Page Progress Indicator -->
    <div class="page-indicator">
        <div class="hud-label">üè∞ Castle Progress</div>
        <div class="hud-value" id="pageProgress">Page 1 of 3</div>
    </div>

    <!-- Victory Screen -->
    <div class="victory-screen" id="victoryScreen">
        <div class="victory-content">
            <div class="victory-title">üèÜ Castle Conquered! üèÜ</div>
            <div class="victory-message">
                You have successfully navigated the treacherous Ember Castle, claimed the legendary Spirit Spear,
                defeated the ancient dragon, and obtained the powerful Ember Relic!
                <br><br>
                <strong>üéØ Final Score:</strong> <span id="finalScore">0</span><br>
                <strong>üëë Kingdom Glory:</strong> <span id="finalKingdomScore">0</span><br>
                <strong>üî• Ember Relic:</strong> <span id="finalEmberRelic">Obtained</span>
            </div>
            <button class="btn-epic" onclick="continueToLevel4()">üåü Continue to Level 4</button>
            <button class="btn-epic" onclick="returnToMenu()">üè† Return to Main Menu</button>
            <button class="btn-epic" onclick="restartLevel()">üîÑ Play Again</button>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div>Position: <span id="debugPos">0, 0</span></div>
        <div>Page: <span id="debugPage">1</span></div>
        <div>Collectibles: <span id="debugCollectibles">0</span></div>
        <div>Has Spirit Spear: <span id="debugSpear">No</span></div>
    </div>

    <script>
        // ===============================================
        // GAME VARIABLES & INITIALIZATION
        // ===============================================
        let canvas = document.getElementById('gameCanvas');
        let ctx = canvas.getContext('2d');

        // Set canvas size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Game state
        let castleGame = {
            player: { 
                x: 50, y: 525, width: 40, height: 55, vx: 0, vy: 0, grounded: false, 
                facingRight: true, direction: 1, animFrame: 0, state: 'idle',
                attacking: false, invulnerable: false,
                baseColor: '#4169E1', // Blue for Kael, can be loaded from character selection
                armorColor: '#C0C0C0',
                weaponColor: '#FFD700'
            },
            camera: { x: 0, y: 0 },
            currentPage: 1,
            score: 0,
            kingdomScore: 0,
            lives: 3,
            hasSpritSpear: false,
            hasEmberRelic: false,
            collectibleCount: 0,
            platforms: [],
            collectibles: [],
            firePits: [],
            enemies: [],
            fireballs: [], // Dragon fire attacks
            exitPortal: null, // Completion portal
            keys: {},
            debugMode: false
        };

        // Physics constants
        const GRAVITY = 0.8;
        const JUMP_FORCE = -15;
        const PLAYER_SPEED = 5;
        const PAGE_WIDTH = 1600;

        // Load scores and character from previous levels
        function loadScores() {
            // Get URL parameters first, fallback to localStorage
            const urlParams = new URLSearchParams(window.location.search);
            
            castleGame.score = parseInt(urlParams.get('playerScore')) || parseInt(localStorage.getItem('azureon_score') || '0');
            castleGame.kingdomScore = parseInt(urlParams.get('kingdomScore')) || parseInt(localStorage.getItem('kingdomScore') || '0');
            castleGame.lives = parseInt(urlParams.get('lives')) || parseInt(localStorage.getItem('playerLives') || '3');
            castleGame.hasForestRelic = urlParams.get('forestRelic') === 'true' || localStorage.getItem('azureon_forest_relic') === 'true';
            
            console.log('üîÆ Level 3 Game Data Loaded:');
            console.log('Forest Relic:', castleGame.hasForestRelic);
            console.log('Score:', castleGame.score);
            console.log('Lives:', castleGame.lives);
            
            const selectedCharacter = localStorage.getItem('selectedCharacter') || 'kael';
            
            // Set character appearance based on selection
            castleGame.player.baseColor = selectedCharacter === 'kael' ? '#4169E1' : '#DC143C';
            castleGame.player.armorColor = '#C0C0C0';
            castleGame.player.weaponColor = '#FFD700';
            
            updateHUD();
        }

        // ===============================================
        // LEVEL CREATION - Castle Themed
        // ===============================================
        function createCastlePage1() {
            const pageOffset = 0;
            
            // Castle platforms with stone texture
            const page1Platforms = [
                // Ground level
                { x: pageOffset + 0, y: 580, width: 400, height: 20, type: 'stone' },
                { x: pageOffset + 500, y: 520, width: 200, height: 20, type: 'stone' },
                { x: pageOffset + 800, y: 460, width: 250, height: 20, type: 'stone' },
                { x: pageOffset + 1150, y: 400, width: 200, height: 20, type: 'stone' },
                { x: pageOffset + 1400, y: 340, width: 200, height: 20, type: 'stone' },
                
                // Mid-level platforms
                { x: pageOffset + 200, y: 450, width: 150, height: 15, type: 'brick' },
                { x: pageOffset + 450, y: 380, width: 120, height: 15, type: 'brick' },
                { x: pageOffset + 650, y: 320, width: 130, height: 15, type: 'brick' },
                { x: pageOffset + 900, y: 280, width: 140, height: 15, type: 'brick' },
                
                // High platforms
                { x: pageOffset + 100, y: 250, width: 120, height: 15, type: 'marble' },
                { x: pageOffset + 350, y: 200, width: 130, height: 15, type: 'marble' },
                { x: pageOffset + 600, y: 180, width: 120, height: 15, type: 'marble' },
                { x: pageOffset + 850, y: 150, width: 140, height: 15, type: 'marble' },
                { x: pageOffset + 1200, y: 200, width: 150, height: 15, type: 'marble' }
            ];
            
            // Collectibles - gold coins, gems, castle treasures, and health potions
            const page1Collectibles = [
                { x: pageOffset + 250, y: 420, type: 'gold', value: 100 },
                { x: pageOffset + 500, y: 350, type: 'ruby', value: 200 },
                { x: pageOffset + 680, y: 290, type: 'emerald', value: 150 },
                { x: pageOffset + 930, y: 250, type: 'gold', value: 100 },
                { x: pageOffset + 1250, y: 170, type: 'sapphire', value: 300 },
                { x: pageOffset + 150, y: 220, type: 'crown', value: 500 },
                { x: pageOffset + 400, y: 170, type: 'chalice', value: 400 },
                { x: pageOffset + 1300, y: 170, type: 'scepter', value: 600 },
                
                // Health potions for extra lives
                { x: pageOffset + 750, y: 430, type: 'health', value: 0 },
                { x: pageOffset + 1050, y: 370, type: 'health', value: 0 }
            ];
            
            // Fire pits - castle dangers
            const page1FirePits = [
                { x: pageOffset + 420, y: 560, width: 60, height: 20 },
                { x: pageOffset + 750, y: 500, width: 40, height: 20 },
                { x: pageOffset + 1100, y: 440, width: 50, height: 20 },
                { x: pageOffset + 350, y: 380, width: 40, height: 20 },
                { x: pageOffset + 580, y: 300, width: 60, height: 20 }
            ];
            
            return { platforms: page1Platforms, collectibles: page1Collectibles, firePits: page1FirePits };
        }

        function createCastlePage2() {
            const pageOffset = PAGE_WIDTH;
            
            // Spirit Spear chamber platforms
            const page2Platforms = [
                // Main chamber floor
                { x: pageOffset + 0, y: 550, width: 600, height: 30, type: 'ancient' },
                { x: pageOffset + 700, y: 480, width: 300, height: 20, type: 'ancient' },
                { x: pageOffset + 1100, y: 420, width: 500, height: 30, type: 'ancient' },
                
                // Chamber steps
                { x: pageOffset + 200, y: 450, width: 100, height: 20, type: 'marble' },
                { x: pageOffset + 350, y: 400, width: 100, height: 20, type: 'marble' },
                { x: pageOffset + 500, y: 350, width: 100, height: 20, type: 'marble' },
                { x: pageOffset + 650, y: 300, width: 100, height: 20, type: 'marble' },
                
                // Spirit Spear altar
                { x: pageOffset + 750, y: 250, width: 200, height: 30, type: 'altar' },
                
                // Upper walkways
                { x: pageOffset + 1050, y: 300, width: 150, height: 15, type: 'bridge' },
                { x: pageOffset + 1250, y: 250, width: 120, height: 15, type: 'bridge' },
                { x: pageOffset + 1400, y: 200, width: 200, height: 20, type: 'ancient' }
            ];
            
            // Page 2 collectibles including Spirit Spear
            const page2Collectibles = [
                { x: pageOffset + 250, y: 420, type: 'gold', value: 150 },
                { x: pageOffset + 400, y: 370, type: 'diamond', value: 400 },
                { x: pageOffset + 550, y: 320, type: 'gold', value: 150 },
                { x: pageOffset + 850, y: 200, type: 'spiritspear', value: 1000 }, // THE SPIRIT SPEAR!
                { x: pageOffset + 1100, y: 270, type: 'ruby', value: 200 },
                { x: pageOffset + 1300, y: 220, type: 'emerald', value: 150 },
                { x: pageOffset + 1450, y: 170, type: 'treasure', value: 500 },
                
                // Health potions for extra lives
                { x: pageOffset + 150, y: 520, type: 'health', value: 0 },
                { x: pageOffset + 1200, y: 390, type: 'health', value: 0 }
            ];
            
            // Chamber fire pits
            const page2FirePits = [
                { x: pageOffset + 620, y: 530, width: 70, height: 20 },
                { x: pageOffset + 1050, y: 460, width: 40, height: 20 },
                { x: pageOffset + 300, y: 380, width: 40, height: 20 },
                { x: pageOffset + 450, y: 330, width: 40, height: 20 },
                { x: pageOffset + 1200, y: 400, width: 40, height: 20 }
            ];
            
            return { platforms: page2Platforms, collectibles: page2Collectibles, firePits: page2FirePits };
        }

        function createCastlePage3() {
            const pageOffset = PAGE_WIDTH * 2;
            
            // Dragon lair platforms
            const page3Platforms = [
                // Dragon chamber floor
                { x: pageOffset + 0, y: 580, width: 800, height: 20, type: 'lava' },
                { x: pageOffset + 900, y: 520, width: 700, height: 30, type: 'lava' },
                
                // Battle platforms
                { x: pageOffset + 150, y: 450, width: 120, height: 15, type: 'obsidian' },
                { x: pageOffset + 350, y: 400, width: 130, height: 15, type: 'obsidian' },
                { x: pageOffset + 550, y: 350, width: 140, height: 15, type: 'obsidian' },
                { x: pageOffset + 750, y: 300, width: 120, height: 15, type: 'obsidian' },
                
                // Dragon perch
                { x: pageOffset + 1000, y: 250, width: 300, height: 40, type: 'dragonstone' },
                
                // Ember Relic altar
                { x: pageOffset + 1400, y: 350, width: 200, height: 30, type: 'relic' }
            ];
            
            // Page 3 collectibles (Ember Relic will be added after dragon defeat)
            const page3Collectibles = [
                { x: pageOffset + 200, y: 420, type: 'gold', value: 200 },
                { x: pageOffset + 400, y: 370, type: 'platinum', value: 500 },
                { x: pageOffset + 600, y: 320, type: 'diamond', value: 400 },
                { x: pageOffset + 800, y: 270, type: 'treasure', value: 600 },
                // EMBER RELIC REMOVED - will spawn after dragon defeat
                
                // Health potions for final battle
                { x: pageOffset + 100, y: 550, type: 'health', value: 0 },
                { x: pageOffset + 900, y: 480, type: 'health', value: 0 },
                { x: pageOffset + 1350, y: 320, type: 'health', value: 0 }
            ];
            
            // Dragon lair fire pits
            const page3FirePits = [
                { x: pageOffset + 820, y: 560, width: 80, height: 20 },
                { x: pageOffset + 100, y: 430, width: 40, height: 20 },
                { x: pageOffset + 300, y: 380, width: 40, height: 20 },
                { x: pageOffset + 500, y: 330, width: 40, height: 20 },
                { x: pageOffset + 950, y: 500, width: 60, height: 20 },
                { x: pageOffset + 1350, y: 330, width: 40, height: 20 }
            ];
            
            return { platforms: page3Platforms, collectibles: page3Collectibles, firePits: page3FirePits };
        }

        // Initialize the entire castle
        function initializeCastle() {
            const page1 = createCastlePage1();
            const page2 = createCastlePage2();
            const page3 = createCastlePage3();
            
            castleGame.platforms = [...page1.platforms, ...page2.platforms, ...page3.platforms];
            castleGame.collectibles = [...page1.collectibles, ...page2.collectibles, ...page3.collectibles];
            castleGame.firePits = [...page1.firePits, ...page2.firePits, ...page3.firePits];
            castleGame.enemies = []; // Start with no enemies
            castleGame.spidersSpawned = false;
            castleGame.spidersDefeated = 0;
            castleGame.totalSpiders = 2;
            castleGame.dragonSpawned = false;
            castleGame.hasForestRelic = false;
        }

        // ===============================================
        // GAME LOGIC - Player Movement & Physics
        // ===============================================
        function updatePlayer() {
            const player = castleGame.player;
            
            // Horizontal movement
            if (castleGame.keys['ArrowLeft'] || castleGame.keys['a']) {
                player.vx = -PLAYER_SPEED;
                player.facingRight = false;
            } else if (castleGame.keys['ArrowRight'] || castleGame.keys['d']) {
                player.vx = PLAYER_SPEED;
                player.facingRight = true;
            } else {
                player.vx *= 0.8; // Friction
            }
            
            // Jumping
            if ((castleGame.keys['ArrowUp'] || castleGame.keys['w'] || castleGame.keys[' ']) && player.grounded) {
                player.vy = JUMP_FORCE;
                player.grounded = false;
            }
            
            // Apply gravity
            if (!player.grounded) {
                player.vy += GRAVITY;
            }
            
            // Update position
            player.x += player.vx;
            player.y += player.vy;
            
            // Update animation
            player.animFrame += 0.15;
            if (Math.abs(player.vx) > 0.1) {
                player.state = 'running';
            } else if (!player.grounded) {
                player.state = 'jumping';
            } else {
                player.state = 'idle';
            }
            
            // Update direction
            if (player.vx > 0) {
                player.direction = 1;
                player.facingRight = true;
            } else if (player.vx < 0) {
                player.direction = -1;
                player.facingRight = false;
            }
            
            // Update attack state based on Shift key
            player.attacking = castleGame.keys['Shift'] && castleGame.hasSpritSpear;
            
            // Platform collision
            player.grounded = false;
            for (let platform of castleGame.platforms) {
                if (player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + platform.height + 10 &&
                    player.vy >= 0) {
                    
                    player.y = platform.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
                    break;
                }
            }
            
            // Screen boundaries
            if (player.y > canvas.height) {
                takeDamage();
            }
            
            // Page transitions
            updatePageTransition();
            
            // Update camera
            updateCamera();
        }

        function updatePageTransition() {
            const player = castleGame.player;
            const pageThreshold = PAGE_WIDTH * 0.95; // 95% of page width
            
            // Forward transitions
            if (castleGame.currentPage === 1 && player.x > pageThreshold) {
                castleGame.currentPage = 2;
                updatePageIndicator();
            } else if (castleGame.currentPage === 2 && player.x > pageThreshold + PAGE_WIDTH) {
                // Can only access Page 3 with Spirit Spear
                if (castleGame.hasSpritSpear) {
                    castleGame.currentPage = 3;
                    updatePageIndicator();
                    
                    // Spawn spiders when entering Page 3
                    if (!castleGame.spidersSpawned) {
                        spawnSpiders();
                        showMessage("üï∑Ô∏è Spider guardians awaken! Defeat them to face the dragon!");
                    }
                } else {
                    // Block access - push player back
                    player.x = pageThreshold + PAGE_WIDTH - 10;
                    showMessage("You need the Spirit Spear to enter the Dragon Lair!");
                }
            }
            
            // Backward transitions
            if (castleGame.currentPage === 3 && player.x < PAGE_WIDTH * 2 + 50) {
                castleGame.currentPage = 2;
                updatePageIndicator();
            } else if (castleGame.currentPage === 2 && player.x < PAGE_WIDTH + 50) {
                castleGame.currentPage = 1;
                updatePageIndicator();
            }
        }

        function updateCamera() {
            const player = castleGame.player;
            const targetX = player.x - canvas.width / 2;
            
            // Smooth camera following
            castleGame.camera.x += (targetX - castleGame.camera.x) * 0.1;
            
            // Keep camera within bounds
            castleGame.camera.x = Math.max(0, Math.min(castleGame.camera.x, PAGE_WIDTH * 3 - canvas.width));
            castleGame.camera.y = 0; // Fixed Y camera for platformer
        }
        
        // Spawn spiders on Page 3
        function spawnSpiders() {
            const pageOffset = PAGE_WIDTH * 2;
            
            const spiders = [
                { x: pageOffset + 450, y: 365, type: 'spider', hp: 1, speed: 1.0, maxHp: 1 },
                { x: pageOffset + 650, y: 315, type: 'spider', hp: 1, speed: 0.9, maxHp: 1 }
            ];
            
            castleGame.enemies = castleGame.enemies.concat(spiders);
            castleGame.spidersSpawned = true;
            console.log('üï∑Ô∏è Spiders spawned on Page 3!');
        }
        
        // Spawn dragon after all spiders are defeated
        function spawnDragon() {
            const pageOffset = PAGE_WIDTH * 2;
            
            const dragon = {
                x: pageOffset + 1100, 
                y: 190, 
                type: 'dragon', 
                hp: 3, 
                maxHp: 3,
                speed: 0.6,
                lastHitTime: 0
            };
            
            castleGame.enemies.push(dragon);
            castleGame.dragonSpawned = true;
            showMessage("üêâ THE ANCIENT DRAGON AWAKENS! 3 hits to defeat!");
            console.log('üêâ Dragon spawned with 5 HP!');
        }

        // ===============================================
        // COLLISION DETECTION & INTERACTIONS
        // ===============================================
        function checkCollectibles() {
            const player = castleGame.player;
            
            for (let i = castleGame.collectibles.length - 1; i >= 0; i--) {
                const collectible = castleGame.collectibles[i];
                
                if (player.x < collectible.x + 30 &&
                    player.x + player.width > collectible.x &&
                    player.y < collectible.y + 30 &&
                    player.y + player.height > collectible.y) {
                    
                    // Collect the item
                    castleGame.score += collectible.value;
                    castleGame.kingdomScore = Math.floor(castleGame.score * 1.5);
                    castleGame.collectibleCount++;
                    
                    // Special items
                    if (collectible.type === 'spiritspear') {
                        castleGame.hasSpritSpear = true;
                        showMessage("üó°Ô∏è Spirit Spear Obtained! You can now enter the Dragon Lair!");
                        updateHUD();
                    } else if (collectible.type === 'emberrelic') {
                        castleGame.hasEmberRelic = true;
                        showMessage("üî• EMBER RELIC OBTAINED! The ancient power flows through you!");
                        updateHUD();
                        
                        // Activate the exit portal
                        if (castleGame.exitPortal) {
                            castleGame.exitPortal.active = true;
                            setTimeout(() => {
                                showMessage("‚ú® Exit portal activated! Head to the far right to complete Level 3!");
                            }, 2000);
                        }
                    } else if (collectible.type === 'health') {
                        // Health potion - restore 1 life (max 5)
                        if (castleGame.lives < 5) {
                            castleGame.lives++;
                            showMessage("‚ù§Ô∏è Health Restored! +1 Life");
                            updateHUD();
                        } else {
                            // If at max lives, give bonus points instead
                            castleGame.score += 500;
                            showMessage("‚ú® Max Lives! +500 Bonus Points");
                            updateHUD();
                        }
                    }
                    
                    // Remove collectible
                    castleGame.collectibles.splice(i, 1);
                    updateHUD();
                }
            }
        }

        function checkFirePits() {
            const player = castleGame.player;
            
            for (let firePit of castleGame.firePits) {
                if (player.x < firePit.x + firePit.width &&
                    player.x + player.width > firePit.x &&
                    player.y + player.height > firePit.y &&
                    player.y + player.height < firePit.y + firePit.height + 10) {
                    
                    takeDamage();
                    break;
                }
            }
        }

        function checkEnemies() {
            const player = castleGame.player;
            
            // Remove defeated enemies with visual effect
            const initialEnemyCount = castleGame.enemies.length;
            castleGame.enemies = castleGame.enemies.filter(enemy => {
                if (enemy.hp <= 0 && enemy.type === 'dragon') {
                    // Dragon death effect
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            castleGame.camera.x += Math.random() * 8 - 4;
                            castleGame.camera.y += Math.random() * 8 - 4;
                        }, i * 100);
                    }
                    
                    // SPAWN EMBER RELIC after dragon is defeated
                    setTimeout(() => {
                        const pageOffset = PAGE_WIDTH * 2; // Page 3 offset
                        const emberRelic = { 
                            x: pageOffset + 1500, 
                            y: 300, 
                            type: 'emberrelic', 
                            value: 2000 
                        };
                        castleGame.collectibles.push(emberRelic);
                        showMessage("üî• The Dragon's defeat releases the EMBER RELIC! Collect it to unlock the exit!");
                    }, 2000); // 2 second delay for dramatic effect
                }
                return enemy.hp > 0;
            });
            
            for (let enemy of castleGame.enemies) {
                
                // Check collision with enemy (larger hitbox for dragon, generous for spiders)
                const enemyWidth = enemy.type === 'dragon' ? 80 : 50; // Larger spider hitbox for easier hits
                const enemyHeight = enemy.type === 'dragon' ? 60 : 50;
                const enemyAttackRange = enemy.type === 'dragon' ? 0 : 30; // Extra attack range for spiders
                
                // Spirit Spear gives much better reach when attacking
                const spearReach = castleGame.hasSpritSpear && castleGame.keys['Shift'] ? 80 : 0;
                const totalAttackRange = enemyAttackRange + spearReach;
                
                const enemyCollision = player.x < enemy.x + enemyWidth + totalAttackRange &&
                    player.x + player.width > enemy.x - totalAttackRange &&
                    player.y < enemy.y + enemyHeight + totalAttackRange &&
                    player.y + player.height > enemy.y - totalAttackRange;
                
                if (enemyCollision) {
                    // Check if player has Spirit Spear and is attacking (Shift key)
                    if (castleGame.hasSpritSpear && castleGame.keys['Shift']) {
                        // Different cooldowns for different enemies
                        const attackCooldown = enemy.type === 'dragon' ? 400 : 200; // Shorter cooldown for spiders
                        if (!enemy.lastHitTime || Date.now() - enemy.lastHitTime > attackCooldown) {
                            enemy.hp--;
                            enemy.lastHitTime = Date.now();
                            
                            // Different scores for different enemies
                            const scoreGain = enemy.type === 'dragon' ? 500 : 300;
                            castleGame.score += scoreGain;
                            updateHUD();
                            
                            // Screen shake effect for hits
                            castleGame.camera.x += Math.random() * 6 - 3;
                            castleGame.camera.y += Math.random() * 6 - 3;
                            
                            // Visual feedback
                            if (enemy.type === 'dragon') {
                                showMessage(`‚ö° CRITICAL HIT! Dragon HP: ${enemy.hp}/3`);
                            } else {
                                showMessage(`‚öîÔ∏è Spider Hit! Easy target eliminated!`);
                            }
                            
                            if (enemy.hp <= 0) {
                                if (enemy.type === 'spider') {
                                    castleGame.spidersDefeated++;
                                    showMessage(`üï∑Ô∏è Spider Slain! (${castleGame.spidersDefeated}/${castleGame.totalSpiders})`);
                                    
                                    // Check if all spiders are defeated
                                    if (castleGame.spidersDefeated >= castleGame.totalSpiders && !castleGame.dragonSpawned) {
                                        setTimeout(() => {
                                            spawnDragon();
                                        }, 2000); // 2 second delay before dragon appears
                                    }
                                } else if (enemy.type === 'dragon') {
                                    showMessage('üêâ THE ANCIENT DRAGON FALLS! Victory is yours!');
                                    // Award bonus points for dragon kill
                                    castleGame.score += 2000;
                                    updateHUD();
                                    
                                    // Spawn the Ember Relic where dragon was
                                    setTimeout(() => {
                                        // Ember relic now spawns from main defeat logic
                                        // Create exit portal at far right of Page 3 (INACTIVE until relic collected)
                                        if (!castleGame.exitPortal) {
                                            castleGame.exitPortal = {
                                                x: PAGE_WIDTH * 3 - 100,
                                                y: 480,
                                                width: 80,
                                                height: 100,
                                                active: false // Will activate when relic is collected
                                            };
                                        }
                                    }, 2000);
                                }
                            }
                        }
                    } else if (!castleGame.hasSpritSpear) {
                        if (!enemy.lastWarnTime || Date.now() - enemy.lastWarnTime > 2000) {
                            showMessage('üö´ You need the Spirit Spear to attack enemies!');
                            enemy.lastWarnTime = Date.now();
                        }
                        takeDamage();
                    } else {
                        if (!enemy.lastWarnTime || Date.now() - enemy.lastWarnTime > 2000) {
                            showMessage('‚öîÔ∏è Hold Shift to attack with the Spirit Spear!');
                            enemy.lastWarnTime = Date.now();
                        }
                        takeDamage();
                    }
                }
            }
        }

        function takeDamage() {
            castleGame.lives--;
            updateHUD();
            
            if (castleGame.lives <= 0) {
                gameOver();
            } else {
                // Respawn player at safe location on platforms
                if (castleGame.currentPage === 1) {
                    castleGame.player.x = 50;
                    castleGame.player.y = 525; // Above first platform at y=580
                } else if (castleGame.currentPage === 2) {
                    castleGame.player.x = PAGE_WIDTH + 50;
                    castleGame.player.y = 520; // Above Page 2 platform
                } else if (castleGame.currentPage === 3) {
                    castleGame.player.x = PAGE_WIDTH * 2 + 50;
                    castleGame.player.y = 520; // Above Page 3 platform
                }
                castleGame.player.vx = 0;
                castleGame.player.vy = 0;
                showMessage(`üíî Life lost! ${castleGame.lives} lives remaining.`);
            }
        }

        function checkExitPortal() {
            if (!castleGame.exitPortal || !castleGame.exitPortal.active) return;
            
            const player = castleGame.player;
            const portal = castleGame.exitPortal;
            
            // Check collision with exit portal
            const portalCollision = player.x < portal.x + portal.width &&
                player.x + player.width > portal.x &&
                player.y < portal.y + portal.height &&
                player.y + player.height > portal.y;
            
            if (portalCollision && castleGame.hasEmberRelic) {
                // Complete Level 3
                completeLevel3();
            } else if (portalCollision && !castleGame.hasEmberRelic) {
                showMessage("üî• You need the Ember Relic to use this portal!");
            }
        }

        // ===============================================
        // RENDERING
        // ===============================================
        function render() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Save context for camera transform
            ctx.save();
            ctx.translate(-castleGame.camera.x, -castleGame.camera.y);
            
            // Render background
            renderBackground();
            
            // Render platforms
            renderPlatforms();
            
            // Render fire pits
            renderFirePits();
            
            // Render collectibles
            renderCollectibles();
            
            // Render enemies
            renderEnemies();
            
            // Render dragon fireballs
            renderFireballs();
            
            // Render exit portal
            renderExitPortal();
            
            // Render player
            renderPlayer();
            
            // Restore context
            ctx.restore();
        }

        function renderBackground() {
            // Castle background gradient with different colors per page
            const currentPageOffset = Math.floor(castleGame.camera.x / PAGE_WIDTH);
            
            if (currentPageOffset === 0) {
                // Page 1 - Castle entrance
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#2F1B14');
                gradient.addColorStop(1, '#1a0f0a');
                ctx.fillStyle = gradient;
            } else if (currentPageOffset === 1) {
                // Page 2 - Spirit chamber
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#3a1f1a');
                gradient.addColorStop(1, '#2F1B14');
                ctx.fillStyle = gradient;
            } else {
                // Page 3 - Dragon lair
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#4a1f1f');
                gradient.addColorStop(1, '#3a1f1a');
                ctx.fillStyle = gradient;
            }
            
            ctx.fillRect(castleGame.camera.x, 0, canvas.width, canvas.height);
        }

        function renderPlatforms() {
            for (let platform of castleGame.platforms) {
                // Platform colors based on type
                switch (platform.type) {
                    case 'stone':
                        ctx.fillStyle = '#8B7355';
                        break;
                    case 'brick':
                        ctx.fillStyle = '#A0522D';
                        break;
                    case 'marble':
                        ctx.fillStyle = '#F5F5DC';
                        break;
                    case 'ancient':
                        ctx.fillStyle = '#696969';
                        break;
                    case 'altar':
                        ctx.fillStyle = '#DAA520';
                        break;
                    case 'bridge':
                        ctx.fillStyle = '#8B4513';
                        break;
                    case 'lava':
                        ctx.fillStyle = '#8B0000';
                        break;
                    case 'obsidian':
                        ctx.fillStyle = '#2F2F2F';
                        break;
                    case 'dragonstone':
                        ctx.fillStyle = '#4B0000';
                        break;
                    case 'relic':
                        ctx.fillStyle = '#FFD700';
                        break;
                    default:
                        ctx.fillStyle = '#8B7355';
                }
                
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // Add border
                ctx.strokeStyle = '#5D4E37';
                ctx.lineWidth = 2;
                ctx.strokeRect(platform.x, platform.y, platform.width, platform.height);
            }
        }

        function renderFirePits() {
            for (let firePit of castleGame.firePits) {
                // Animated fire effect
                const time = Date.now() * 0.01;
                const flicker = Math.sin(time + firePit.x * 0.01) * 0.3 + 0.7;
                
                ctx.fillStyle = `rgba(255, ${Math.floor(69 * flicker)}, 0, 0.8)`;
                ctx.fillRect(firePit.x, firePit.y, firePit.width, firePit.height);
                
                // Fire particles
                for (let i = 0; i < 3; i++) {
                    const particleX = firePit.x + Math.random() * firePit.width;
                    const particleY = firePit.y - Math.random() * 20;
                    const size = Math.random() * 8 + 4;
                    
                    ctx.fillStyle = `rgba(255, ${Math.floor(Math.random() * 100 + 100)}, 0, ${Math.random() * 0.8 + 0.2})`;
                    ctx.fillRect(particleX, particleY, size, size);
                }
            }
        }

        function renderCollectibles() {
            for (let collectible of castleGame.collectibles) {
                const time = Date.now() * 0.005;
                const bob = Math.sin(time + collectible.x * 0.01) * 3;
                const y = collectible.y + bob;
                
                // Collectible colors and symbols
                let symbol, color;
                switch (collectible.type) {
                    case 'gold':
                        symbol = 'üí∞';
                        color = '#FFD700';
                        break;
                    case 'ruby':
                        symbol = 'üíé';
                        color = '#DC143C';
                        break;
                    case 'emerald':
                        symbol = 'üíö';
                        color = '#50C878';
                        break;
                    case 'sapphire':
                        symbol = 'üíô';
                        color = '#0F52BA';
                        break;
                    case 'diamond':
                        symbol = 'üíç';
                        color = '#B9F2FF';
                        break;
                    case 'platinum':
                        symbol = '‚≠ê';
                        color = '#E5E4E2';
                        break;
                    case 'crown':
                        symbol = 'üëë';
                        color = '#FFD700';
                        break;
                    case 'chalice':
                        symbol = 'üèÜ';
                        color = '#DAA520';
                        break;
                    case 'scepter':
                        symbol = 'üî±';
                        color = '#B8860B';
                        break;
                    case 'treasure':
                        symbol = 'üìø';
                        color = '#FF6347';
                        break;
                    case 'spiritspear':
                        symbol = 'üó°Ô∏è';
                        color = '#4169E1';
                        break;
                    case 'emberrelic':
                        symbol = 'üî•';
                        color = '#FF4500';
                        break;
                    case 'health':
                        symbol = '‚ù§Ô∏è';
                        color = '#FF1493';
                        break;
                    default:
                        symbol = '‚≠ê';
                        color = '#FFD700';
                }
                
                // Glow effect
                ctx.shadowColor = color;
                ctx.shadowBlur = 15;
                
                // Draw collectible
                ctx.fillStyle = color;
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(symbol, collectible.x + 15, y + 20);
                
                // Reset shadow
                ctx.shadowBlur = 0;
            }
        }

        function updateEnemies() {
            const player = castleGame.player;
            
            for (let enemy of castleGame.enemies) {
                if (enemy.hp <= 0) continue;
                
                // AI - Enemies move toward player (spiders are less aggressive)
                const distanceToPlayer = player.x - enemy.x;
                const detectionRange = enemy.type === 'dragon' ? 300 : 200; // Shorter range for spiders
                const playerInRange = Math.abs(distanceToPlayer) < detectionRange;
                
                if (playerInRange && enemy.type === 'spider') {
                    // Spiders move slowly and pause occasionally
                    if (Math.random() < 0.7) { // 30% chance to pause each frame
                        if (distanceToPlayer > 50) {
                            enemy.x += enemy.speed * 0.5; // Half speed approach
                        } else if (distanceToPlayer < -50) {
                            enemy.x -= enemy.speed * 0.5;
                        }
                    }
                } else if (playerInRange && enemy.type === 'dragon') {
                    // Dragon fire attack - breathe fire every 3-4 seconds when player is in range
                    if (!enemy.lastFireTime || Date.now() - enemy.lastFireTime > 3000 + Math.random() * 1000) {
                        enemy.lastFireTime = Date.now();
                        
                        // Create horizontal fireball
                        const fireDirection = distanceToPlayer > 0 ? 1 : -1;
                        castleGame.fireballs.push({
                            x: enemy.x + (fireDirection > 0 ? 60 : -20), // Offset from dragon mouth
                            y: enemy.y + 20, // Middle height of dragon
                            vx: fireDirection * 8, // Fast horizontal speed
                            vy: 0, // Purely horizontal
                            size: 25,
                            life: 120, // Lives for 2 seconds at 60fps
                            damage: 1
                        });
                        
                        showMessage('üî• DRAGON BREATHES FIRE! Jump to dodge!');
                    }
                    
                    // Dragon movement - less aggressive when breathing fire
                    const timeSinceFireAttack = enemy.lastFireTime ? Date.now() - enemy.lastFireTime : 9999;
                    if (timeSinceFireAttack > 1000) { // Only move if not recently fired
                        if (distanceToPlayer > 100) {
                            enemy.x += enemy.speed * 0.8;
                        } else if (distanceToPlayer < -100) {
                            enemy.x -= enemy.speed * 0.8;
                        }
                    }
                } else {
                    // Random patrol movement when player is far
                    if (enemy.type === 'dragon') {
                        // Dragons move more menacingly
                        enemy.x += enemy.speed * Math.sin(Date.now() * 0.0008 + enemy.x * 0.005) * 2;
                    } else {
                        // Spiders move very little when patrolling
                        enemy.x += enemy.speed * Math.sin(Date.now() * 0.0005 + enemy.x * 0.01) * 0.5;
                        
                        // Spiders freeze when player is attacking nearby
                        const distToPlayer = Math.abs(castleGame.player.x - enemy.x);
                        if (castleGame.player.attacking && distToPlayer < 100) {
                            // Don't move - easier to hit
                        }
                    }
                }
                
                // Keep enemies on platforms (basic collision)
                const enemyHeight = enemy.type === 'dragon' ? 60 : 40;
                const onPlatform = castleGame.platforms.some(platform => 
                    enemy.x > platform.x - 20 && 
                    enemy.x < platform.x + platform.width + 20 &&
                    Math.abs(enemy.y + enemyHeight - platform.y) < 15
                );
                
                if (!onPlatform) {
                    // Move back toward center of nearest platform
                    const nearestPlatform = castleGame.platforms.reduce((closest, platform) => {
                        const distance = Math.abs(platform.x + platform.width/2 - enemy.x);
                        return distance < Math.abs(closest.x + closest.width/2 - enemy.x) ? platform : closest;
                    });
                    
                    if (nearestPlatform) {
                        const platformCenter = nearestPlatform.x + nearestPlatform.width/2;
                        enemy.x += (platformCenter - enemy.x) * 0.02;
                    }
                }
            }
        }
        
        function updateFireballs() {
            const player = castleGame.player;
            
            // Update each fireball
            for (let i = castleGame.fireballs.length - 1; i >= 0; i--) {
                const fireball = castleGame.fireballs[i];
                
                // Move fireball
                fireball.x += fireball.vx;
                fireball.y += fireball.vy;
                fireball.life--;
                
                // Check collision with player
                const playerCollision = player.x < fireball.x + fireball.size &&
                    player.x + player.width > fireball.x &&
                    player.y < fireball.y + fireball.size &&
                    player.y + player.height > fireball.y;
                
                if (playerCollision) {
                    // Player takes damage
                    takeDamage();
                    castleGame.fireballs.splice(i, 1); // Remove fireball
                    continue;
                }
                
                // Check collision with platforms (fireballs stop at platforms)
                const platformCollision = castleGame.platforms.some(platform => 
                    fireball.x < platform.x + platform.width &&
                    fireball.x + fireball.size > platform.x &&
                    fireball.y < platform.y + platform.height &&
                    fireball.y + fireball.size > platform.y
                );
                
                // Remove fireball if it hits platform or expires
                if (platformCollision || fireball.life <= 0 || fireball.x < -100 || fireball.x > PAGE_WIDTH * 3 + 100) {
                    castleGame.fireballs.splice(i, 1);
                }
            }
        }
        
        function renderEnemies() {
            for (let enemy of castleGame.enemies) {
                if (enemy.hp <= 0) continue; // This check is now redundant but kept for safety
                
                let symbol, color;
                if (enemy.type === 'spider') {
                    symbol = 'üï∑Ô∏è';
                    color = '#4B0082';
                } else if (enemy.type === 'dragon') {
                    symbol = 'üêâ';
                    color = '#DC143C';
                }
                
                // Glow effect
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                
                // Draw enemy with size based on type
                ctx.fillStyle = color;
                if (enemy.type === 'dragon') {
                    // Large, scary dragon
                    ctx.font = '72px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(symbol, enemy.x + 30, enemy.y + 50);
                    
                    // Add dragon fire breath effect
                    const breathTime = Date.now() * 0.005;
                    const breathOffset = Math.sin(breathTime) * 10;
                    ctx.fillStyle = 'rgba(255, 69, 0, 0.7)';
                    ctx.font = '24px Arial';
                    ctx.fillText('üî•', enemy.x + 60 + breathOffset, enemy.y + 20);
                    ctx.fillText('üî•', enemy.x + 80 + breathOffset * 1.5, enemy.y + 35);
                    ctx.fillText('üî•', enemy.x + 70 + breathOffset * 0.8, enemy.y + 50);
                } else {
                    // Regular spider size
                    ctx.font = '32px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(symbol, enemy.x + 20, enemy.y + 30);
                }
                
                // HP indicator (larger for dragon)
                const hpBarWidth = enemy.type === 'dragon' ? 80 : 40;
                const hpBarY = enemy.type === 'dragon' ? enemy.y - 15 : enemy.y - 10;
                const hpBarHeight = enemy.type === 'dragon' ? 6 : 4;
                
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(enemy.x, hpBarY, hpBarWidth, hpBarHeight);
                ctx.fillStyle = '#00FF00';
                ctx.fillRect(enemy.x, hpBarY, (hpBarWidth * enemy.hp) / (enemy.maxHp || 1), hpBarHeight);
                
                // HP text for dragon
                if (enemy.type === 'dragon') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${enemy.hp}/${enemy.maxHp}`, enemy.x + hpBarWidth/2, hpBarY - 5);
                }
                
                // Reset shadow
                ctx.shadowBlur = 0;
            }
        }

        function renderFireballs() {
            for (let fireball of castleGame.fireballs) {
                // Fireball glow effect
                ctx.shadowColor = '#FF4500';
                ctx.shadowBlur = 15;
                
                // Draw fireball with flickering effect
                const flicker = Math.sin(Date.now() * 0.02) * 0.2 + 0.8;
                ctx.globalAlpha = flicker;
                
                // Main fireball
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.arc(fireball.x + fireball.size/2, fireball.y + fireball.size/2, fireball.size/2, 0, Math.PI * 2);
                ctx.fill();
                
                // Inner core
                ctx.fillStyle = '#FFFF00';
                ctx.beginPath();
                ctx.arc(fireball.x + fireball.size/2, fireball.y + fireball.size/2, fireball.size/3, 0, Math.PI * 2);
                ctx.fill();
                
                // Fire emoji for extra effect
                ctx.font = `${fireball.size}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText('üî•', fireball.x + fireball.size/2, fireball.y + fireball.size * 0.8);
                
                // Reset effects
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }
        }

        function renderExitPortal() {
            if (!castleGame.exitPortal) return;
            
            const portal = castleGame.exitPortal;
            const time = Date.now() * 0.008;
            
            if (portal.active) {
                // Swirling portal effect
                ctx.save();
                ctx.translate(portal.x + portal.width/2, portal.y + portal.height/2);
                ctx.rotate(time);
                
                // Outer ring
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 4;
                ctx.shadowColor = '#FFD700';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(0, 0, 35, 0, Math.PI * 2);
                ctx.stroke();
                
                // Inner ring
                ctx.strokeStyle = '#FF4500';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, 25, 0, Math.PI * 2);
                ctx.stroke();
                
                // Center
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
                
                // Portal label
                ctx.fillStyle = '#FFD700';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('EXIT', portal.x + portal.width/2, portal.y - 10);
                
                // Reset shadow
                ctx.shadowBlur = 0;
            }
        }

        function renderPlayer() {
            const player = castleGame.player;
            const x = player.x;
            const y = player.y;
            const frame = Math.floor(player.animFrame);
            
            // Apply invulnerability flashing
            if (player.invulnerable && Math.floor(Date.now() / 100) % 2) {
                ctx.globalAlpha = 0.5;
            }
            
            // Warrior body with animation
            let bodyOffset = 0;
            if (player.state === 'running') {
                bodyOffset = Math.sin(frame * 0.5) * 2;
            } else if (player.state === 'jumping') {
                bodyOffset = Math.sin(frame * 0.4) * 1;
            }
            
            // Armor (main body)
            ctx.fillStyle = player.baseColor;
            ctx.fillRect(x + 8, y + 15 + bodyOffset, 24, 30);
            
            // Armor details
            ctx.fillStyle = player.armorColor;
            ctx.fillRect(x + 10, y + 17 + bodyOffset, 20, 5);
            ctx.fillRect(x + 12, y + 25 + bodyOffset, 16, 3);
            ctx.fillRect(x + 14, y + 35 + bodyOffset, 12, 3);
            
            // Head
            ctx.fillStyle = '#FFE4B5';
            ctx.fillRect(x + 12, y + 5, 16, 12);
            
            // Helmet
            ctx.fillStyle = player.armorColor;
            ctx.fillRect(x + 10, y + 3, 20, 8);
            
            // Eyes
            ctx.fillStyle = '#000';
            if (player.direction > 0) {
                ctx.fillRect(x + 20, y + 8, 2, 2);
                ctx.fillRect(x + 24, y + 8, 2, 2);
            } else {
                ctx.fillRect(x + 14, y + 8, 2, 2);
                ctx.fillRect(x + 18, y + 8, 2, 2);
            }
            
            // Legs with running animation
            const legOffset1 = player.state === 'running' ? Math.sin(frame * 0.8) * 3 : 0;
            const legOffset2 = player.state === 'running' ? Math.sin(frame * 0.8 + Math.PI) * 3 : 0;
            
            ctx.fillStyle = player.baseColor;
            ctx.fillRect(x + 12, y + 45 + legOffset1, 6, 8);
            ctx.fillRect(x + 22, y + 45 + legOffset2, 6, 8);
            
            // Arms with animation
            const armOffset = player.state === 'running' ? Math.sin(frame * 0.6) * 2 : 0;
            ctx.fillRect(x + 5, y + 20 + armOffset, 6, 15);
            ctx.fillRect(x + 29, y + 20 - armOffset, 6, 15);
            
            // Draw Spirit Spear if found
            if (castleGame.hasSpritSpear) {
                const spearX = player.direction > 0 ? x + 35 : x + 2;
                const spearY = y + 10;
                
                if (player.attacking) {
                    // Attacking position - spear extended
                    ctx.fillStyle = '#FFD700'; // Golden spear tip
                    if (player.direction > 0) {
                        ctx.fillRect(spearX + 10, spearY - 5, 4, 8);
                        ctx.fillRect(spearX + 12, spearY + 3, 2, 30);
                    } else {
                        ctx.fillRect(spearX - 25, spearY - 5, 4, 8);
                        ctx.fillRect(spearX - 27, spearY + 3, 2, 30);
                    }
                    
                    // Spear glow effect when attacking
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                    if (player.direction > 0) {
                        ctx.fillRect(spearX + 8, spearY - 7, 8, 40);
                    } else {
                        ctx.fillRect(spearX - 29, spearY - 7, 8, 40);
                    }
                    
                    // Handle (extended)
                    ctx.fillStyle = '#8B4513';
                    if (player.direction > 0) {
                        ctx.fillRect(spearX + 8, spearY + 33, 6, 10);
                    } else {
                        ctx.fillRect(spearX - 20, spearY + 33, 6, 10);
                    }
                } else {
                    // Resting position - spear at side
                    ctx.fillStyle = '#FFD700'; // Golden spear tip
                    ctx.fillRect(spearX, spearY - 2, 3, 6);
                    ctx.fillRect(spearX + 1, spearY + 4, 1, 25);
                    
                    // Handle
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(spearX - 1, spearY + 29, 5, 6);
                }
            } else {
                // Basic weapon (before Spirit Spear is found)
                ctx.fillStyle = player.weaponColor;
                if (player.direction > 0) {
                    ctx.fillRect(x + 35, y + 18, 3, 12);
                    ctx.fillRect(x + 34, y + 15, 5, 3); // Hilt
                } else {
                    ctx.fillRect(x + 2, y + 18, 3, 12);
                    ctx.fillRect(x + 1, y + 15, 5, 3); // Hilt
                }
            }
            
            // Cape flowing in wind (castle theme - darker cape)
            if (player.state === 'running' || player.state === 'jumping') {
                ctx.fillStyle = '#4B0000'; // Darker red for castle theme
                const capeFlow = Math.sin(frame * 0.4) * 3;
                if (player.direction > 0) {
                    ctx.fillRect(x - 5 + capeFlow, y + 18, 8, 20);
                } else {
                    ctx.fillRect(x + 37 - capeFlow, y + 18, 8, 20);
                }
            }
            
            ctx.globalAlpha = 1;
        }

        // ===============================================
        // UI UPDATES
        // ===============================================
        function updateHUD() {
            document.getElementById('heroScore').textContent = castleGame.score;
            document.getElementById('kingdomScore').textContent = castleGame.kingdomScore;
            
            // Update lives with Forest Relic star if obtained
            const livesDisplay = document.getElementById('livesCount');
            const forestRelicStar = document.getElementById('forestRelicStar');
            livesDisplay.innerHTML = `${castleGame.lives} <span id="forestRelicStar" style="${castleGame.hasForestRelic ? 'display: inline;' : 'display: none;'}">‚≠ê</span>`;
            
            document.getElementById('emberRelic').textContent = castleGame.hasEmberRelic ? '‚úÖ' : '‚ùå';
            
            // Update debug panel if active
            if (castleGame.debugMode) {
                document.getElementById('debugPos').textContent = `${Math.floor(castleGame.player.x)}, ${Math.floor(castleGame.player.y)}`;
                document.getElementById('debugPage').textContent = castleGame.currentPage;
                document.getElementById('debugCollectibles').textContent = castleGame.collectibleCount;
                document.getElementById('debugSpear').textContent = castleGame.hasSpritSpear ? 'Yes' : 'No';
                
                // Add attack debug info
                const debugPanel = document.getElementById('debugPanel');
                if (debugPanel.children.length < 6) {
                    const attackDiv = document.createElement('div');
                    attackDiv.id = 'debugAttack';
                    debugPanel.appendChild(attackDiv);
                    
                    const enemyDiv = document.createElement('div');
                    enemyDiv.id = 'debugEnemies';
                    debugPanel.appendChild(enemyDiv);
                }
                document.getElementById('debugAttack').textContent = `Attacking: ${castleGame.player.attacking ? 'Yes' : 'No'} | Shift: ${castleGame.keys['Shift'] ? 'Yes' : 'No'}`;
                document.getElementById('debugEnemies').textContent = `Enemies: ${castleGame.enemies.length} | Spiders Defeated: ${castleGame.spidersDefeated}/2`;
                
                // Show if player is in attack range of any enemy
                const nearbyEnemy = castleGame.enemies.find(enemy => {
                    const dist = Math.abs(castleGame.player.x - enemy.x);
                    return dist < (enemy.type === 'spider' ? 80 : 50);
                });
                if (debugPanel.children.length < 7) {
                    const rangeDiv = document.createElement('div');
                    rangeDiv.id = 'debugRange';
                    debugPanel.appendChild(rangeDiv);
                }
                document.getElementById('debugRange').textContent = `In Range: ${nearbyEnemy ? nearbyEnemy.type : 'None'}`;
            }
        }

        function updatePageIndicator() {
            document.getElementById('pageProgress').textContent = `Page ${castleGame.currentPage} of 3`;
        }

        function showMessage(message) {
            // Remove existing messages to prevent spam
            const existingMessages = document.querySelectorAll('.game-message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create temporary message display
            const messageDiv = document.createElement('div');
            messageDiv.className = 'game-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 60%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.9);
                color: #FFD700;
                padding: 15px 25px;
                border-radius: 10px;
                border: 2px solid #d4af37;
                font-size: 1.1em;
                z-index: 500;
                text-align: center;
                font-family: 'Cinzel', serif;
                box-shadow: 0 4px 15px rgba(212, 175, 55, 0.5);
                animation: messageSlide 0.3s ease-out;
            `;
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 2500);
        }

        function showVictory() {
            // Save completion state
            localStorage.setItem('azureon_score', castleGame.playerScore.toString());
            localStorage.setItem('kingdomScore', castleGame.kingdomScore.toString());
            localStorage.setItem('azureon_lives', castleGame.lives.toString());
            localStorage.setItem('azureon_ember_relic', 'true');
            
            // Update victory screen
            document.getElementById('finalScore').textContent = castleGame.score;
            document.getElementById('finalKingdomScore').textContent = castleGame.kingdomScore;
            document.getElementById('finalEmberRelic').textContent = 'Obtained ‚úÖ';
            
            // Show victory screen
            document.getElementById('victoryScreen').classList.add('active');
        }

        function gameOver() {
            showMessage('üíÄ Game Over! The castle has claimed another hero...');
            setTimeout(() => {
                restartLevel();
            }, 3000);
        }

        function completeLevel3() {
            showMessage('üéâ LEVEL 3 COMPLETE! You have successfully retrieved the Ember Relic!');
            
            // Save final scores
            const finalPlayerScore = castleGame.score;
            const finalKingdomScore = castleGame.kingdomScore;
            
            // Show victory screen instead of automatic redirect
            showVictory();
        }

        // ===============================================
        // EVENT HANDLERS
        // ===============================================
        function handleKeyDown(event) {
            castleGame.keys[event.key] = true;
            
            // Toggle debug mode
            if (event.key === '`') {
                castleGame.debugMode = !castleGame.debugMode;
                document.getElementById('debugPanel').classList.toggle('active');
            }
            
            // Prevent default for game controls
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' ', 'w', 'a', 's', 'd'].includes(event.key)) {
                event.preventDefault();
            }
        }

        function handleKeyUp(event) {
            castleGame.keys[event.key] = false;
            // Attack state is now managed in updatePlayer function
        }

        // Menu functions
        function continueToLevel4() {
            // Pass game data to Level 4
            const gameParams = new URLSearchParams({
                playerScore: castleGame.playerScore,
                kingdomScore: castleGame.kingdomScore,
                lives: castleGame.lives,
                forestRelic: castleGame.hasForestRelic,
                emberRelic: castleGame.hasEmberRelic,
                character: castleGame.characterChoice || 'boy'
            });
            
            window.location.href = `level4.html?${gameParams.toString()}`;
        }

        function returnToMenu() {
            window.location.href = 'index.html';
        }

        function restartLevel() {
            window.location.reload();
        }

        // ===============================================
        // GAME LOOP
        // ===============================================
        function gameLoop() {
            updatePlayer();
            updateEnemies();
            updateFireballs(); // Dragon fire attacks
            checkCollectibles();
            checkFirePits();
            checkEnemies();
            checkExitPortal(); // Level completion
            render();
            requestAnimationFrame(gameLoop);
        }

        // ===============================================
        // INITIALIZATION
        // ===============================================
        function initGame() {
            console.log('üè∞ Level 3: Ember Castle - Initializing...');
            
            // Load scores from previous levels
            loadScores();
            
            // Create castle levels
            initializeCastle();
            
            // Set up event listeners
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('keyup', handleKeyUp);
            
            // Handle window resize
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
            
            // Initialize HUD
            updateHUD();
            updatePageIndicator();
            
            // Show initial message
            setTimeout(() => {
                showMessage('üè∞ Welcome to the Ember Castle! Spiders are slow - easy targets for your spear!');
            }, 1000);
            
            // Start game loop
            gameLoop();
            
            console.log('‚úÖ Level 3: Ember Castle - Ready!');
        }

        // Start the game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>